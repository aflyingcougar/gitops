---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: velero
spec:
  values:
    annotations:
      secret.reloader.stakater.com/reload: "velero-minio-secret"
    resources:
      requests:
        cpu: 500m
        memory: 128Mi
      limits:
        cpu: 1000m
        memory: 512Mi
    initContainers:
      - name: velero-plugin-for-csi
        image: velero/velero-plugin-for-csi:v0.2.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins
      - name: velero-plugin-for-aws
        image: velero/velero-plugin-for-aws:v1.3.0
        imagePullPolicy: IfNotPresent
        volumeMounts:
          - mountPath: /target
            name: plugins
    nodeSelector:
      kubernetes.io/arch: "amd64"
    metrics:
      enabled: true
      scrapeInterval: 30s
      scrapeTimeout: 10s
      service:
        annotations: {}
        labels: {}
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8085"
        prometheus.io/path: "/metrics"
      serviceMonitor:
        enabled: false
        additionalLabels: {}
    kubectl:
      image:
        repository: docker.io/bitnami/kubectl
    upgradeCRDs: true
    cleanUpCRDs: false
    configuration:
      provider: aws
      backupStorageLocation:
        name: local-minio
        bucket: prod
        prefix: ""
        default: true
        config:
          region: minio
          s3ForcePathStyle: true
          s3Url: http://192.168.130.50:9001
          publicUrl: http://192.168.130.50:9001
      # features: EnableCSI, EnableUploadProgress
      logLevel: info
      logFormat: json
      defaultVolumesToRestic:
      # How often 'restic prune' is run for restic repositories by default. Default: 168h. Optional.
      defaultResticPruneFrequency:
    credentials:
      useSecret: true
      existingSecret: velero-minio-secret
    backupsEnabled: true
    snapshotsEnabled: false
    deployRestic: true
    restic:
      podVolumePath: /var/lib/kubelet/pods
      privileged: true
      nodeSelector:
        kubernetes.io/arch: "amd64"
    schedules:
      default:
        disabled: false
        labels:
          velero: default
        annotations:
          velero: default
        schedule: "0 3 * * 0"
        useOwnerReferencesInBackup: true
        template:
          ttl: "240h"
    # Velero ConfigMaps.
    # Eg:
    # configMaps:
    #   restic-restore-action-config:
    #     labels:
    #       velero.io/plugin-config: ""
    #       velero.io/restic: RestoreItemAction
    #     data:
    #       image: velero/velero-restic-restore-helper:v1.7.0
    configMaps: {}
