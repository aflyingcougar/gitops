---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: navidrome
spec:
  values:
    podSecurityContext:
      fsGroup: 1177
      runAsNonRoot: true
      runAsUser: 1177
      runAsGroup: 1177
    env:
      ND_SCANINTERVAL: 15m
      ND_LOGLEVEL: info
      ND_SESSIONTIMEOUT: 24h
      ND_ENABLETRANSCODINGCONFIG: "true"
      ND_MUSICFOLDER: /music
    persistence:
      config:
        enabled: true
        emptyDir: false
        mountPath: /data
        existingClaim: "navidrome-config-longhorn"
      music:
        enabled: true
        emptyDir: false
        mountPath: /music
        accessMode: ReadWriteOnce
        skipuninstall: false
        existingClaim: "music-library-apollo"
    ingress:
      main:
        enabled: false
        ingressClassName: "traefik-external"
        annotations:
          external-dns.alpha.kubernetes.io/target: ${DYNAMIC_DOMAIN}
          external-dns/public: "true"
          hajimari.io/enable: "true"
          hajimari.io/icon: "music"
          hajimari.io/appName: "Navidrome"
          hajimari.io/group: "Media"
        hosts:
          - host: "music.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: ImplementationSpecific
        tls:
          - hosts:
              - "music.${SECRET_DOMAIN}"
            secretName: "crj-wildcard-certificate"
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        cpu: 300m
        memory: 512Mi
