---
apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: host-logging
spec:
  mode: daemonset
  image: otel/opentelemetry-collector-contrib:0.80.0
  nodeSelector:
    kubernetes.io/arch: amd64
  volumeMounts:
    - name: hostvarlog
      mountPath: /host/var/log
    - name: scratchdir
      mountPath: /var/lib/otelcol
  volumes:
    - name: hostvarlog
      hostPath:
        path: /var/log
        type: Directory
    - name: scratchdir
      emptyDir:
        sizeLimit: 10Gi
  env:
    - name: K8S_NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
  config: |
    receivers:
      filelog:
        include:
          - /host/var/log/syslog
          - /host/var/log/pods/*
        start_at: end
        storage: file_storage
        include_file_path: true
        include_file_name: true
        operators:
          - type: move
            from: attributes["log.file.path"]
            to: resource["path"]
      otlp:
        protocols:
          grpc:
    processors:
      batch:
      resource:
        attributes:
          - action: insert
            key: loki.resource.labels
            value: log.file.name, path, unit
          - action: insert
            key: loki.format
            value: raw
      k8sattributes:
        filter:
          node_from_env_var: K8S_NODE_NAME
    exporters:
      logging:
        verbosity: detailed
      loki:
        endpoint: "http://100.64.0.4:3100/loki/api/v1/push"
    extensions:
      health_check:
        path: "/health/status"
        endpoint: ":13333"
      file_storage:
        directory: /var/lib/otelcol
        timeout: 1s
        compaction:
          on_start: true
          on_rebound: true
          directory: /var/lib/otelcol
          max_transaction_size: 65530
      memory_ballast:
        size_in_percentage: 30
    service:
      extensions:
        - health_check
        - file_storage
        - memory_ballast
      telemetry:
        metrics:
          address: "localhost:8888"
      pipelines:
        logs:
          receivers:
            - otlp
            - filelog
          processors:
            - k8sattributes
            - resource
            - batch
          exporters:
            - logging
            - loki
