---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: promtail
spec:
  values:
    resources:
      limits:
        cpu: 150m
        memory: 128Mi
      requests:
        cpu: 50m
        memory: 128Mi
    containerSecurityContext:
      readOnlyRootFilesystem: true
      capabilities:
        drop:
          - ALL
      allowPrivilegeEscalation: false
    defaultVolumes:
      - name: containers
        hostPath:
          path: /var/lib/docker/containers
      - name: pods
        hostPath:
          path: /var/log/pods
    defaultVolumeMounts:
      - name: containers
        mountPath: /var/lib/docker/containers
        readOnly: true
      - name: pods
        mountPath: /var/log/pods
        readOnly: true
    # ServiceMonitor configuration
    serviceMonitor:
      # -- If enabled, ServiceMonitor resources for Prometheus Operator are created
      enabled: false
      # -- Alternative namespace for ServiceMonitor resources
      namespace: null
      # -- Namespace selector for ServiceMonitor resources
      namespaceSelector: {}
      # -- ServiceMonitor annotations
      annotations: {}
      # -- Additional ServiceMonitor labels
      labels: {}
      # -- ServiceMonitor scrape interval
      interval: null
      # -- ServiceMonitor scrape timeout in Go duration format (e.g. 15s)
      scrapeTimeout: null

    # -- Configure additional ports and services. For each configured port, a corresponding service is created.
    # See values.yaml for details
    extraPorts:
      syslog:
        name: tcp-syslog
        containerPort: 1514
        protocol: TCP
        service:
          type: ClusterIP
          clusterIP: null
          port: 1514
          externalIPs: []
          nodePort: null
          annotations: {}
          labels: {}
          loadBalancerIP: null
          loadBalancerSourceRanges: []
          externalTrafficPolicy: null
    config:
      # -- The log level of the Promtail server
      # Must be reference in `config.file` to configure `server.log_level`
      # See default config in `values.yaml`
      logLevel: info
      # -- The port of the Promtail server
      # Must be reference in `config.file` to configure `server.http_listen_port`
      # See default config in `values.yaml`
      serverPort: 3101
      # -- The Loki address to post logs to.
      # Must be reference in `config.file` to configure `client.url`.
      # See default config in `values.yaml`
      lokiAddress: http://loki-gateway/loki/api/v1/push
      # -- A section of reusable snippets that can be reference in `config.file`.
      # Custom snippets may be added in order to reduce redundancy.
      # This is especially helpful when multiple `kubernetes_sd_configs` are use which usually have large parts in common.
      # @default -- See `values.yaml`
      snippets:
        pipelineStages:
          - cri: {}
        common:
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_node_name
            target_label: node_name
          - action: replace
            source_labels:
              - __meta_kubernetes_namespace
            target_label: namespace
          - action: replace
            replacement: $1
            separator: /
            source_labels:
              - namespace
              - app
            target_label: job
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_name
            target_label: pod
          - action: replace
            source_labels:
              - __meta_kubernetes_pod_container_name
            target_label: container
          - action: replace
            replacement: /var/log/pods/*$1/*.log
            separator: /
            source_labels:
              - __meta_kubernetes_pod_uid
              - __meta_kubernetes_pod_container_name
            target_label: __path__
          - action: replace
            replacement: /var/log/pods/*$1/*.log
            regex: true/(.*)
            separator: /
            source_labels:
              - __meta_kubernetes_pod_annotationpresent_kubernetes_io_config_hash
              - __meta_kubernetes_pod_annotation_kubernetes_io_config_hash
              - __meta_kubernetes_pod_container_name
            target_label: __path__
        # If set to true, adds an additional label for the scrape job.
        # This helps debug the Promtail config.
        addScrapeJobLabel: false
        # -- You can put here any keys that will be directly added to the config file's 'client' block.
        # @default -- empty
        extraClientConfigs: ""
        # -- You can put here any additional scrape configs you want to add to the config file.
        # @default -- empty
        extraScrapeConfigs: ""
        # -- You can put here any additional relabel_configs to "kubernetes-pods" job
        extraRelabelConfigs: []
        scrapeConfigs: |
          # See also https://github.com/grafana/loki/blob/master/production/ksonnet/promtail/scrape_config.libsonnet for reference
          - job_name: kubernetes-pods
            pipeline_stages:
              {{- toYaml .Values.config.snippets.pipelineStages | nindent 4 }}
            kubernetes_sd_configs:
              - role: pod
            relabel_configs:
              - source_labels:
                  - __meta_kubernetes_pod_controller_name
                regex: ([0-9a-z-.]+?)(-[0-9a-f]{8,10})?
                action: replace
                target_label: __tmp_controller_name
              - source_labels:
                  - __meta_kubernetes_pod_label_app_kubernetes_io_name
                  - __meta_kubernetes_pod_label_app
                  - __tmp_controller_name
                  - __meta_kubernetes_pod_name
                regex: ^;*([^;]+)(;.*)?$
                action: replace
                target_label: app
              - source_labels:
                  - __meta_kubernetes_pod_label_app_kubernetes_io_component
                  - __meta_kubernetes_pod_label_component
                regex: ^;*([^;]+)(;.*)?$
                action: replace
                target_label: component
              {{- if .Values.config.snippets.addScrapeJobLabel }}
              - replacement: kubernetes-pods
                target_label: scrape_job
              {{- end }}
              {{- toYaml .Values.config.snippets.common | nindent 4 }}
              {{- with .Values.config.snippets.extraRelabelConfigs }}
              {{- toYaml . | nindent 4 }}
              {{- end }}
          - job_name: syslog
            syslog:
              listen_address: 0.0.0.0:1514
              labels:
                job: "syslog"
            relabel_configs:
              - source_labels: ['__syslog_connection_ip_address']
                target_label: 'ip_address'
              - source_labels: ['__syslog_message_severity']
                target_label: 'severity'
              - source_labels: ['__syslog_message_facility']
                target_label: 'facility'
              - source_labels: ['__syslog_message_hostname']
                target_label: 'host'
      file: |
        server:
          log_level: {{ .Values.config.logLevel }}
          http_listen_port: {{ .Values.config.serverPort }}
        client:
          url: {{ tpl .Values.config.lokiAddress . }}
          {{- tpl .Values.config.snippets.extraClientConfigs . | nindent 2 }}
        positions:
          filename: /run/promtail/positions.yaml
        scrape_configs:
          {{- tpl .Values.config.snippets.scrapeConfigs . | nindent 2 }}
          {{- tpl .Values.config.snippets.extraScrapeConfigs . | nindent 2 }}
