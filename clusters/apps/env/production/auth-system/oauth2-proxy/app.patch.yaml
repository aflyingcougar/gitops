---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
spec:
  values:
    extraEnv:
      - name: OAUTH2_PROXY_PROVIDER
        value: "keycloak-oidc"
      - name: OAUTH2_PROXY_OIDC_ISSUER_URL
        value: "https://keycloak.crutonjohn.com/auth/realms/crutonjohn"
    config:
      clientID: "${AUTH0_CLIENT_ID}"
      clientSecret: "${AUTH0_CLIENT_SECRET}"
      cookieSecret: "${OAUTH2_PROXY_COOKIE_SECRET}"
      configFile:
    ingress:
      enabled: true
      className: "traefik-external"
      annotations:
        external-dns.alpha.kubernetes.io/target: ${DYNAMIC_DOMAIN}
        external-dns/public: "true"
      hosts:
        - "auth.${SECRET_DOMAIN}"
      tls:
        - hosts:
            - "auth.${SECRET_DOMAIN}"
          secretName: "crj-wildcard-certificate"
    resources:
      limits:
        cpu: 100m
        memory: 300Mi
      requests:
        cpu: 100m
        memory: 300Mi
    nodeSelector:
      kubernetes.io/arch: "amd64"
