---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: frigate
spec:
  values:
    podAnnotations:
      configmap.reloader.stakater.com/reload: "frigate-prod-config"
    image:
      repository: ghcr.io/k8s-at-home/frigate
      tag: 0.10.1-amd64
      pullPolicy: IfNotPresent
    env:
      TZ: "America/New_York"
    configmap:
      config:
        enabled: true
        data:
          config.yml: |
            logger:
              default: debug
            mqtt:
              host: emqx
              topic_prefix: frigate
              user: "${SECRET_MQTT_USERNAME}"
              password: "${SECRET_MQTT_PASSWORD}"
            database:
              path: /data/frigate.db
            birdseye:
              enabled: True
              width: 2560
              height: 1440
              quality: 8
              mode: continuous
            detectors:
              coral:
               type: edgetpu
               device: pci
            ffmpeg:
              hwaccel_args:
                - -hwaccel
                - vaapi
                - -hwaccel_device
                - /dev/dri/renderD128
                - -hwaccel_output_format
                - yuv420p
              output_args:
                record: -f segment -segment_time 10 -segment_format mp4 -reset_timestamps 1 -strftime 1 -c:v copy -c:a aac
            objects:
              track:
                - person
                - dog
              filters:
                person:
                  min_area: 2500
                  max_area: 100000
                  threshold: 0.7
                dog:
                  min_area: 1000
                  max_area: 10000
                  threshold: 0.7
            cameras:
              # --
              kitchen-e1-pro:
                ffmpeg:
                  inputs:
                    - path: rtsp://admin:${REOLINK_ADMIN_PASSWORD}@192.168.134.64:554/h264Preview_01_sub
                      roles:
                        - detect
                    - path: rtsp://admin:${REOLINK_ADMIN_PASSWORD}@192.168.134.64:554/h264Preview_01_main
                      roles:
                        - record
                        - rtmp
                  input_args:
                    - -avoid_negative_ts
                    - make_zero
                    - -flags
                    - low_delay
                    - -strict
                    - experimental
                    - -fflags
                    - nobuffer+genpts+discardcorrupt
                    - -analyzeduration
                    - 1000M
                    - -probesize
                    - 1000M
                detect:
                  height: 360
                  width: 640
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                    objects:
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: False
                  retain:
                    default: 14
              # --
              sitting-room-e1-pro:
                ffmpeg:
                  inputs:
                    - path: rtsp://admin:${REOLINK_ADMIN_PASSWORD}@192.168.134.65:554/h264Preview_01_sub
                      roles:
                        - detect
                    - path: rtsp://admin:${REOLINK_ADMIN_PASSWORD}@192.168.134.65:554/h264Preview_01_main
                      roles:
                        - record
                        - rtmp
                  input_args:
                    - -avoid_negative_ts
                    - make_zero
                    - -flags
                    - low_delay
                    - -strict
                    - experimental
                    - -fflags
                    - nobuffer+genpts+discardcorrupt
                    - -analyzeduration
                    - 1000M
                    - -probesize
                    - 1000M
                detect:
                  height: 360
                  width: 640
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                    objects:
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: False
                  retain:
                    default: 14
              # --
              living-room-e1-pro:
                ffmpeg:
                  inputs:
                    - path: rtsp://admin:${REOLINK_ADMIN_PASSWORD}@192.168.134.66:554/h264Preview_01_sub
                      roles:
                        - detect
                    - path: rtsp://admin:${REOLINK_ADMIN_PASSWORD}@192.168.134.66:554/h264Preview_01_main
                      roles:
                        - record
                        - rtmp
                  input_args:
                    - -avoid_negative_ts
                    - make_zero
                    - -flags
                    - low_delay
                    - -strict
                    - experimental
                    - -fflags
                    - nobuffer+genpts+discardcorrupt
                    - -analyzeduration
                    - 1000M
                    - -probesize
                    - 1000M
                detect:
                  height: 360
                  width: 640
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                    objects:
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: False
                  retain:
                    default: 14
              # --
              front-doorbell-ad410:
                ffmpeg:
                  inputs:
                    - path: rtsp://admin:${AMCREST_ADMIN_PASSWORD}@192.168.134.61:554/cam/realmonitor?channel=1&subtype=01
                      roles:
                        - detect
                    - path: rtsp://admin:${AMCREST_ADMIN_PASSWORD}@192.168.134.61:554/cam/realmonitor?channel=1&subtype=0
                      roles:
                        - record
                        - rtmp
                detect:
                  height: 1920
                  width: 2560
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                        car: 30
                    objects:
                      - car
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: True
                  retain:
                    default: 30
              # --
              kitchen-doorbell-ad410:
                ffmpeg:
                  inputs:
                    - path: rtsp://admin:${AMCREST_ADMIN_PASSWORD}@192.168.134.62:554/cam/realmonitor?channel=1&subtype=01
                      roles:
                        - detect
                    - path: rtsp://admin:${AMCREST_ADMIN_PASSWORD}@192.168.134.62:554/cam/realmonitor?channel=1&subtype=0
                      roles:
                        - record
                        - rtmp
                detect:
                  height: 1920
                  width: 2560
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                        car: 30
                    objects:
                      - car
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: True
                  retain:
                    default: 30
              # --
              south-west-1:
                ffmpeg:
                  inputs:
                    - path: https://192.168.134.67/flv?port=1935&app=bcs&stream=channel0_sub.bcs&user=admin&password=${REOLINK_ADMIN_PASSWORD}
                      roles:
                        - detect
                    - path: https://192.168.134.67/flv?port=1935&app=bcs&stream=channel0_ext.bcs&user=admin&password=${REOLINK_ADMIN_PASSWORD}
                      roles:
                        - record
                        - rtmp
                  input_args:
                    - -avoid_negative_ts
                    - make_zero
                    - -flags
                    - low_delay
                    - -strict
                    - experimental
                    - -fflags
                    - nobuffer+genpts+discardcorrupt
                    - -analyzeduration
                    - 1000M
                    - -probesize
                    - 1000M
                detect:
                  width: 896
                  height: 512
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                    objects:
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: False
                  retain:
                    default: 14
              # --
              south-west-2:
                ffmpeg:
                  inputs:
                    - path: https://192.168.134.68/flv?port=1935&app=bcs&stream=channel0_sub.bcs&user=admin&password=${REOLINK_ADMIN_PASSWORD}
                      roles:
                        - detect
                    - path: https://192.168.134.68/flv?port=1935&app=bcs&stream=channel0_ext.bcs&user=admin&password=${REOLINK_ADMIN_PASSWORD}
                      roles:
                        - record
                        - rtmp
                  input_args:
                    - -avoid_negative_ts
                    - make_zero
                    - -flags
                    - low_delay
                    - -strict
                    - experimental
                    - -fflags
                    - nobuffer+genpts+discardcorrupt
                    - -analyzeduration
                    - 1000M
                    - -probesize
                    - 1000M
                detect:
                  width: 896
                  height: 512
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                    objects:
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: False
                  retain:
                    default: 14
              # --
              north-door-1:
                ffmpeg:
                  inputs:
                    - path: https://192.168.134.69/flv?port=1935&app=bcs&stream=channel0_sub.bcs&user=admin&password=${REOLINK_ADMIN_PASSWORD}
                      roles:
                        - detect
                    - path: https://192.168.134.69/flv?port=1935&app=bcs&stream=channel0_ext.bcs&user=admin&password=${REOLINK_ADMIN_PASSWORD}
                      roles:
                        - record
                        - rtmp
                  input_args:
                    - -avoid_negative_ts
                    - make_zero
                    - -flags
                    - low_delay
                    - -strict
                    - experimental
                    - -fflags
                    - nobuffer+genpts+discardcorrupt
                    - -analyzeduration
                    - 1000M
                    - -probesize
                    - 1000M
                detect:
                  width: 896
                  height: 512
                record:
                  enabled: True
                  retain_days: 2
                  events:
                    retain:
                      objects:
                        person: 50
                        dog: 20
                    objects:
                      - person
                      - dog
                snapshots:
                  enabled: True
                  timestamp: False
                  retain:
                    default: 14
    ingress:
      main:
        enabled: false
        ingressClassName: "traefik-internal"
        annotations:
          hajimari.io/enable: "true"
          hajimari.io/icon: "cctv"
          hajimari.io/appName: "Frigate"
          hajimari.io/group: "Home"
        hosts:
          - host: "frigate.${SECRET_DOMAIN}"
            paths:
              - path: /
                pathType: ImplementationSpecific
        tls:
          - hosts:
              - "frigate.${SECRET_DOMAIN}"
            secretName: "crj-wildcard-certificate"
    service:
      main:
        ports:
          rtmp-tcp:
            enabled: true
            primary: false
            port: 1935
            protocol: TCP
            targetPort: 1935
          rtmp-udp:
            enabled: true
            primary: false
            port: 1935
            protocol: UDP
            targetPort: 1935
    persistence:
      data:
        enabled: true
        mountPath: /data
        existingClaim: frigate-data-longhorn
      media:
        enabled: true
        mountPath: /media
        existingClaim: frigate-data-apollo
      cache:
        enabled: true
        type: emptyDir
        medium: Memory
        sizeLimit: 2Gi
        mountPath: /dev/shm
      video:
        enabled: true
        type: hostPath
        hostPath: /dev/dri/renderD128
        mountPath: /dev/dri/renderD128
      coral:
        enabled: true
        type: hostPath
        hostPath: /dev/apex_0
        mountPath: /dev/apex_0
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
                - key: feature.node.kubernetes.io/custom-coral-tpu
                  operator: In
                  values:
                    - "true"
                - key: feature.node.kubernetes.io/custom-intel-gpu
                  operator: In
                  values:
                    - "true"
    resources:
      requests:
        memory: 1024Mi
        cpu: 100m
      limits:
        memory: 4000Mi
    securityContext:
      privileged: true
