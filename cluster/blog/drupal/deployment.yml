---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: drupal-test
  namespace: blog
  annotations:
    fluxcd.io/ignore: "false"
    fluxcd.io/automated: "true"
spec:
  releaseName: drupal-test
  helmVersion: v3
  chart:
    repository: https://charts.bitnami.com/bitnami
    name: drupal
    version: 10.0.2
  values:
    global:
      storageClass: "longhorn-nightly"
    image:
      registry: docker.io
      repository: bitnami/drupal
      tag: '8-debian-10'
      pullPolicy: IfNotPresent
      debug: false
    replicaCount: 1
    drupalProfile: standard
    drupalSkipInstall: false
    mariadb:
      enabled: true
      architecture: standalone
      primary:
        persistence:
          enabled: true
          storageClass: "longhorn-nightly"
          accessModes:
          - ReadWriteOnce
          size: 8Gi
    containerPorts:
      http: 8080
      https: 8443
    service:
      type: ClusterIP
      port: 80
      httpsPort: 443
      externalTrafficPolicy: Cluster
    sessionAffinity: "None"
    persistence:
      enabled: true
      storageClass: "longhorn-nightly"
      accessMode: ReadWriteOnce
      size: 8Gi
    resources:
      requests:
        memory: 512Mi
        cpu: 300m
    podSecurityContext:
      enabled: true
      fsGroup: 2001
    containerSecurityContext:
      enabled: true
      runAsUser: 2001
    livenessProbe:
      enabled: true
      path: /user/login
      initialDelaySeconds: 600
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 5
      successThreshold: 1
    readinessProbe:
      enabled: true
      path: /user/login
      initialDelaySeconds: 30
      periodSeconds: 5
      timeoutSeconds: 1
      failureThreshold: 5
      successThreshold: 1
    metrics:
      enabled: false
      image:
        registry: docker.io
        repository: bitnami/apache-exporter
        tag: '0-debian-10'
        pullPolicy: IfNotPresent
        ## Optionally specify an array of imagePullSecrets.
        ## Secrets must be manually created in the namespace.
        ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
        ##
        pullSecrets:
        #   - myRegistryKeySecretName
      ## Metrics exporter resource requests and limits
      ## ref: http://kubernetes.io/docs/user-guide/compute-resources/
      ##
      # resources: {}
      ## Metrics exporter pod Annotation and Labels
      ##
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9117"
  valueFileSecrets:
  - name: "drupal-helm-values"
