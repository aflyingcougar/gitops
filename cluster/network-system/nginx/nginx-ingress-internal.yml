---
apiVersion: helm.fluxcd.io/v1
kind: HelmRelease
metadata:
  name: nginx-ingress-internal
  namespace: network-system
  annotations:
    fluxcd.io/ignore: "false"
    fluxcd.io/automated: "false"
spec:
  releaseName: nginx-ingress-internal
  helmVersion: v3
  rollback:
    enable: false
  chart:
    repository: https://helm.nginx.com/stable
    name: ingress-nginx
    version: 0.6.1
  values:
    controller:
      ## The name of the Ingress controller daemonset or deployment.
      ## Autogenerated if not set or set to "".
      name: nginx-ingress-internal
      ## The kind of the Ingress controller installation - deployment or daemonset.
      kind: deployment
      image:
        ## The image repository of the Ingress controller.
        repository: nginx/nginx-ingress
        tag: 1.8.1
        pullPolicy: IfNotPresent
      config:
        ## The name of the ConfigMap used by the Ingress controller.
        ## Autogenerated if not set or set to "".
        name: nginx-config-internal

        ## The annotations of the Ingress Controller configmap.
        annotations: {}

        ## The entries of the ConfigMap for customizing NGINX configuration.
        entries: {}
      ## The node selector for pod assignment for the Ingress controller pods.
      nodeSelector:
        node-role.kubernetes.io/master: ""

      ## The termination grace period of the Ingress controller pod.
      terminationGracePeriodSeconds: 30

      ## The resources of the Ingress controller pods.
      resources: {}
        # limits:
        #   cpu: 100m
        #   memory: 64Mi
        # requests:
        #   cpu: 100m
        #   memory: 64Mi

      ## The tolerations of the Ingress controller pods.
      tolerations:
      - key: "node-role.kubernetes.io/master"
        effect: "NoSchedule"

      ## The affinity of the Ingress controller pods.
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - nginx-ingress-internal
            topologyKey: kubernetes.io/hostname
      ## The volumes of the Ingress controller pods.
      volumes: []
      # - name: extra-conf
      #   configMap:
      #     name: extra-conf

      ## The volumeMounts of the Ingress controller pods.
      volumeMounts: []
      # - name: extra-conf
      #   mountPath: /etc/nginx/conf.d/extra.conf
      #   subPath: extra.conf

      ## The number of replicas of the Ingress controller deployment.
      replicaCount: 3

      ## A class of the Ingress controller.

      ## For Kubernetes >= 1.18, a corresponding IngressClass resource with the name equal to the class must be deployed. Otherwise,
      ## the Ingress Controller will fail to start.
      ## The Ingress controller only processes resources that belong to its class - i.e. have the "ingressClassName" field resource equal to the class.

      ## For Kubernetes < 1.18, the Ingress Controller only processes resources that belong to its class
      ## - i.e have the annotation "kubernetes.io/ingress.class" equal to the class.
      ## Additionally, the Ingress Controller processes resources that do not have the class set, which can be disabled by setting the "-use-ingress-class-only" flag

      ## The Ingress Controller processes all the VirtualServer/VirtualServerRoute resources that do not have the "ingressClassName" field for all versions of kubernetes.
      ingressClass: internal
      ## Namespace to watch for Ingress resources. By default the Ingress controller watches all namespaces.
      watchNamespace: ""

      ## Enable the custom resources.
      enableCustomResources: true
      service:
        ## Creates a service to expose the Ingress controller pods.
        create: true
        ## The type of service to create for the Ingress controller.
        type: LoadBalancer
        ## The externalTrafficPolicy of the service. The value Local preserves the client source IP.
        externalTrafficPolicy: Local
        ## The annotations of the Ingress controller service.
        annotations: {}
        ## The static IP address for the load balancer. Requires controller.service.type set to LoadBalancer. The cloud provider must support this feature.
        loadBalancerIP: "192.168.130.101"
        ## The list of external IPs for the Ingress controller service.
        externalIPs: []
        ## The IP ranges (CIDR) that are allowed to access the load balancer. Requires controller.service.type set to LoadBalancer. The cloud provider must support this feature.
        loadBalancerSourceRanges: []
        name: nginx-ingress-internal
    prometheus:
      ## Expose NGINX or NGINX Plus metrics in the Prometheus format.
      create: true

      ## Configures the port to scrape the metrics.
      port: 9113
